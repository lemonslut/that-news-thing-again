<div class="container">
  <nav class="back">
    <%= link_to "&larr; Back".html_safe, articles_path %>
  </nav>

  <% if flash[:notice] %>
    <div class="notice"><%= flash[:notice] %></div>
  <% end %>
  <% if flash[:alert] %>
    <div class="alert"><%= flash[:alert] %></div>
  <% end %>

  <article class="detail">
    <% if @article.category %>
      <span class="category <%= @article.category.name %>"><%= @article.category.name %></span>
    <% end %>

    <h1><%= @article.title %></h1>

    <% if @article.calm_summary %>
      <div class="calm-summary">
        <h3>The calm version</h3>
        <p><%= @article.calm_summary.summary %></p>
      </div>
    <% end %>

    <div class="meta">
      <span class="source"><%= entity_link_by_type_and_name("publisher", @article.source_name) %></span>
      <% if @article.author.present? %>
        <span class="author">by
          <%= @article.author.split(/,\s*/).map { |a| entity_link_by_type_and_name("author", a.strip.downcase) }.join(", ").html_safe %>
        </span>
      <% end %>
      <time datetime="<%= @article.published_at.iso8601 %>"><%= @article.published_at.strftime("%B %-d, %Y at %-I:%M %p") %></time>
    </div>

    <% if @article.image_url.present? %>
      <div class="image">
        <%= image_tag @article.image_url, alt: @article.title %>
      </div>
    <% end %>

    <% if @article.description.present? %>
      <div class="description">
        <p><%= @article.description %></p>
      </div>
    <% end %>

    <% if @article.entities.any? %>
      <div class="analysis">
        <h3>Entities</h3>

        <% if @article.tags.any? %>
          <div class="tags">
            <strong>Tags:</strong>
            <% @article.tags.each do |entity| %>
              <span class="tag"><%= entity_link(entity) %></span>
            <% end %>
          </div>
        <% end %>

        <% if @article.people.any? %>
          <div class="entity-group">
            <strong>People:</strong>
            <%= @article.people.map { |e| entity_link(e) }.join(", ").html_safe %>
          </div>
        <% end %>

        <% if @article.organizations.any? %>
          <div class="entity-group">
            <strong>Organizations:</strong>
            <%= @article.organizations.map { |e| entity_link(e) }.join(", ").html_safe %>
          </div>
        <% end %>

        <% if @article.places.any? %>
          <div class="entity-group">
            <strong>Places:</strong>
            <%= @article.places.map { |e| entity_link(e) }.join(", ").html_safe %>
          </div>
        <% end %>

        <% if @article.latest_extraction %>
          <p class="model-info">
            Entities extracted by <%= @article.latest_extraction.model_used %>
            <% if @article.latest_extraction.prompt %>
              using <%= @article.latest_extraction.prompt %>
            <% end %>
          </p>
        <% end %>

        <% if @article.calm_summary %>
          <p class="model-info">
            Summary by <%= @article.calm_summary.model_used %>
            <% if @article.calm_summary.prompt %>
              using <%= @article.calm_summary.prompt %>
            <% end %>
          </p>
        <% end %>
      </div>
    <% else %>
      <div class="no-analysis">
        <p>This article hasn't been analyzed yet.</p>
      </div>
    <% end %>

    <div class="original">
      <%= link_to "Read original article", @article.url, target: "_blank", rel: "noopener" %>
    </div>
  </article>

  <section class="prompt-section">
    <h2>Re-analyze</h2>

    <div class="reanalyze-options">
      <%= form_with url: reanalyze_article_path(@article), method: :post, local: true do |f| %>
        <input type="hidden" name="type" value="all">
        <button type="submit" class="btn">Re-run all analysis</button>
      <% end %>

      <%= form_with url: reanalyze_article_path(@article), method: :post, local: true do |f| %>
        <input type="hidden" name="type" value="entities">
        <button type="submit" class="btn btn-secondary">Re-extract entities only</button>
      <% end %>

      <%= form_with url: reanalyze_article_path(@article), method: :post, local: true do |f| %>
        <input type="hidden" name="type" value="summary">
        <button type="submit" class="btn btn-secondary">Re-generate summary only</button>
      <% end %>
    </div>
  </section>
</div>
