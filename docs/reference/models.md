# Models Reference

## Article

Stores articles fetched from NewsAPI.

### Schema

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | no | Primary key |
| source_id | string | yes | NewsAPI source identifier |
| source_name | string | no | Source display name |
| author | string | yes | Article author |
| title | string | no | Article headline |
| description | text | yes | Short description |
| url | string | no | Original article URL (unique) |
| image_url | string | yes | Featured image URL |
| published_at | datetime | no | Publication timestamp |
| content | text | yes | Truncated content (200 chars from NewsAPI) |
| raw_payload | jsonb | no | Complete NewsAPI response |
| created_at | datetime | no | Record creation time |
| updated_at | datetime | no | Record update time |

### Associations

- `has_many :entity_extractions` — ArticleEntityExtraction records
- `has_many :calm_summaries` — ArticleCalmSummary records
- `has_many :article_entities` — Join table to entities
- `has_many :entities, through: :article_entities` — Direct entity access

### Scopes

- `recent` — Order by published_at DESC
- `from_source(name)` — Filter by source_name
- `published_after(time)` — Articles after timestamp
- `published_before(time)` — Articles before timestamp
- `with_entities` — Articles that have entity extractions
- `without_entities` — Articles lacking entity extractions
- `with_summary` — Articles that have calm summaries
- `without_summary` — Articles lacking calm summaries
- `in_category(cat)` — Articles with matching category entity

### Instance Methods

- `calm_summary` — Returns latest ArticleCalmSummary
- `category` — Returns category Entity
- `tags` — Returns tag entities
- `people` — Returns person entities
- `organizations` — Returns organization entities
- `places` — Returns place entities
- `latest_extraction` — Returns most recent ArticleEntityExtraction

### Class Methods

- `from_news_api(hash)` — Build Article from NewsAPI response hash
- `upsert_from_news_api(hash)` — Create or update by URL

---

## Entity

Normalized entities extracted from articles. All names are lowercase.

### Schema

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | no | Primary key |
| entity_type | string | no | Type: person, organization, place, tag, category, publisher, author |
| name | string | no | Normalized name (lowercase) |
| created_at | datetime | no | Record creation time |
| updated_at | datetime | no | Record update time |

### Constants

```ruby
TYPES = %w[person organization place publisher author tag category]
```

### Associations

- `has_many :article_entities` — Join table records
- `has_many :articles, through: :article_entities` — Articles with this entity
- `has_many :article_entity_extraction_entities` — Extraction provenance
- `has_many :extractions, through: :article_entity_extraction_entities` — Which extractions found this

### Scopes

- `of_type(type)` — Filter by entity_type
- `people` — Entities of type "person"
- `organizations` — Entities of type "organization"
- `places` — Entities of type "place"
- `publishers` — Entities of type "publisher"
- `authors` — Entities of type "author"
- `tags` — Entities of type "tag"
- `categories` — Entities of type "category"

### Class Methods

- `find_or_create(type, name)` — Find or create with normalized name
- `normalize_name(name)` — Returns downcased, stripped name

---

## ArticleEntityExtraction

Audit trail for entity extraction. Records when and how entities were extracted.

### Schema

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | no | Primary key |
| article_id | bigint | no | Foreign key to articles |
| prompt_id | bigint | yes | Foreign key to prompts (optional) |
| model_used | string | no | LLM model identifier |
| raw_response | jsonb | no | Complete LLM response |
| created_at | datetime | no | Record creation time |
| updated_at | datetime | no | Record update time |

### Associations

- `belongs_to :article`
- `belongs_to :prompt` (optional)
- `has_many :article_entity_extraction_entities` — Join table
- `has_many :entities, through: :article_entity_extraction_entities` — Entities from this extraction

### Instance Methods

- `link_entities_from_result(result)` — Creates entity records and links from LLM response

---

## ArticleCalmSummary

Stores calm summaries generated by LLM.

### Schema

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | no | Primary key |
| article_id | bigint | no | Foreign key to articles |
| prompt_id | bigint | yes | Foreign key to prompts (optional) |
| model_used | string | no | LLM model identifier |
| summary | text | no | The calm summary text |
| raw_response | jsonb | no | Complete LLM response |
| created_at | datetime | no | Record creation time |
| updated_at | datetime | no | Record update time |

### Associations

- `belongs_to :article`
- `belongs_to :prompt` (optional)

### Scopes

- `recent` — Order by article.published_at DESC

---

## ArticleEntity

Join table for canonical article-entity relationship.

### Schema

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | no | Primary key |
| article_id | bigint | no | Foreign key to articles |
| entity_id | bigint | no | Foreign key to entities |
| created_at | datetime | no | Record creation time |
| updated_at | datetime | no | Record update time |

### Associations

- `belongs_to :article`
- `belongs_to :entity`

---

## Prompt

Stores versioned prompts for LLM jobs.

### Schema

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | no | Primary key |
| name | string | no | Prompt name (e.g., "entity_extraction", "calm_summary") |
| version | integer | no | Version number |
| body | text | no | Prompt text |
| active | boolean | no | Whether this is the current active version |
| created_at | datetime | no | Record creation time |
| updated_at | datetime | no | Record update time |

### Associations

- `has_many :article_entity_extractions`
- `has_many :article_calm_summaries`

### Class Methods

- `current(name)` — Returns active prompt for given name

### Instance Methods

- `activate!` — Makes this prompt the active version (deactivates others)
